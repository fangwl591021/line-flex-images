<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Âº∑Âà∂Èò≤Âø´ÂèñÊ®ôÁ±§ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Flex Sender Ultra Pro v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Fira+Code:wght@400;500&display=swap');
        
        :root {
            --line-green: #06C755;
            --line-blue: #748da6;
            --editor-bg: #1e1e1e;
            --header-bg: #1e293b; /* v2.0 Â∞àÊ•≠Ê∑±ÁÅ∞Ëâ≤È¢®Ê†º */
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9; 
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--header-bg);
            border-bottom: 2px solid rgba(255,255,255,0.1);
            padding: 0 1.5rem;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            z-index: 50;
        }

        header h1 { color: white; }

        .liff-id-container {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 14px;
            padding: 0.6rem 1.2rem;
            display: flex;
            align-items: center;
            gap: 12px;
            width: 550px;
            transition: all 0.2s;
        }

        .liff-id-container:focus-within {
            border-color: var(--line-green);
            background: rgba(255,255,255,0.12);
            box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.2);
        }

        .liff-id-container input {
            color: white;
            font-weight: bold;
            font-family: 'Fira Code', monospace;
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--editor-bg);
        }

        #json-input {
            flex: 1;
            padding: 1.5rem;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            border: none;
            outline: none;
            resize: none;
            background: transparent;
            color: #d4d4d4;
            tab-size: 4;
        }

        .preview-wrapper {
            width: 550px;
            background: #e2e8f0;
            border-left: 1px solid #cbd5e1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .device-frame {
            width: 380px;
            min-height: 680px;
            background: var(--line-blue);
            border-radius: 48px;
            border: 12px solid #020617;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .device-header {
            height: 42px;
            background: rgba(0,0,0,0.15);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .device-header::after {
            content: '';
            width: 55px;
            height: 5px;
            background: rgba(255,255,255,0.25);
            border-radius: 10px;
        }

        .device-screen {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        .device-screen::-webkit-scrollbar { display: none; }

        .flex-bubble-card {
            background: white;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-online { background: #22c55e; box-shadow: 0 0 12px #22c55e; }
        .status-offline { background: #ef4444; box-shadow: 0 0 12px #ef4444; }

        .btn-send {
            background: var(--line-green);
            color: white;
            padding: 12px 36px;
            border-radius: 16px;
            font-weight: 900;
            font-size: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(6, 199, 85, 0.4);
        }
        .btn-send:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-send:active { transform: translateY(0); }

        .btn-tool {
            background: #334155;
            color: #f1f5f9;
            padding: 7px 15px;
            border-radius: 9px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 7px;
            transition: all 0.2s;
        }
        .btn-tool:hover { background: #475569; color: white; }
    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-4">
            <div class="bg-emerald-500 p-2.5 rounded-2xl text-white shadow-lg">
                <i data-lucide="layout"></i>
            </div>
            <div>
                <h1 class="font-black m-0 text-xl flex items-center gap-3 tracking-tight">
                    Flex Sender Pro <span class="text-xs bg-emerald-600 text-white px-2 py-0.5 rounded-full">v2.0</span>
                    <span id="liff-status-indicator" class="status-dot status-offline"></span>
                </h1>
                <p id="user-status-text" class="text-[10px] text-slate-400 font-bold uppercase m-0 tracking-widest">Initialization Required</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="liff-id-container shadow-inner">
                <i data-lucide="shield-check" class="w-5 h-5 text-emerald-500"></i>
                <input type="text" id="liff-id-input" placeholder="Ë≤ºÂÖ•ÊÇ®ÁöÑ LIFF ID (‰æãÂ¶Ç 200xxxxxxx-xxxxxxxx)" 
                       class="bg-transparent text-sm w-full outline-none font-bold">
            </div>
            <button id="btn-login-trigger" onclick="liff.login()" class="hidden text-sm font-bold text-emerald-400 hover:text-white underline">ÁôªÂÖ•Â∏≥Ëôü</button>
            <button onclick="sendFlexMessage()" class="btn-send">
                <i data-lucide="share-2" class="w-5 h-5"></i> ÂàÜ‰∫´Â•ΩÂèã
            </button>
        </div>
    </header>

    <main>
        <!-- Á∑®ËºØÂçÄ -->
        <section class="editor-wrapper">
            <div class="px-6 py-3 border-b border-white/10 flex justify-between items-center bg-[#252526]">
                <div class="flex items-center gap-6">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="file-json" class="w-4 h-4"></i> JSON Editor
                    </span>
                    <div class="flex items-center gap-2 bg-[#3c3c3c] rounded-lg px-3 py-1 text-white border border-white/5">
                        <span class="text-[9px] font-bold text-slate-400 uppercase">Alt Text</span>
                        <input type="text" id="alt-text-input" value="Êî∂Âà∞Á≤æÈÅ∏Ë®äÊÅØ" 
                               class="text-xs bg-transparent outline-none w-64 font-medium">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="generateShareUrl()" class="btn-tool !bg-emerald-700 !text-white shadow-lg">
                        <i data-lucide="link-2" class="w-4 h-4"></i> Ë£Ω‰ΩúÂ£ìÁ∏ÆÁü≠ÈÄ£Áµê
                    </button>
                    <button onclick="formatCode()" class="btn-tool">
                        <i data-lucide="wand-2" class="w-4 h-4"></i> Ê†ºÂºèÂåñ
                    </button>
                    <button onclick="clearAll()" class="btn-tool !text-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Ê∏ÖÁ©∫
                    </button>
                </div>
            </div>
            <textarea id="json-input" spellcheck="false" placeholder="Âú®Ê≠§ËôïË≤º‰∏ä Flex Message JSON..."></textarea>
        </section>

        <!-- È†êË¶ΩÂçÄ -->
        <section class="preview-wrapper custom-scrollbar">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="smartphone" class="w-5 h-5 text-slate-500"></i>
                <span class="text-[11px] font-black text-slate-500 uppercase tracking-[0.3em]">Device Live Preview</span>
            </div>
            
            <div class="device-frame">
                <div class="device-header"></div>
                <div class="device-screen">
                    <div id="flex-render-mount" class="flex flex-col gap-5 pb-10"></div>
                </div>
            </div>

            <div class="mt-8 bg-white p-4 rounded-2xl border border-slate-200 w-full max-w-[380px] shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[10px] font-black text-slate-400 uppercase flex items-center gap-1.5">
                        <i data-lucide="link" class="w-3 h-3"></i> Current Endpoint
                    </p>
                    <span id="url-len-badge" class="text-[9px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-bold">0 chars</span>
                </div>
                <code id="debug-url" class="text-[9px] text-emerald-600 block break-all font-mono bg-slate-50 p-2 rounded-lg border border-slate-100"></code>
                <p class="text-[9px] text-slate-300 mt-2 italic text-center">‚Äª Ë´ãÁ¢∫‰øù LINE ÂæåÂè∞ Endpoint ËàáÊ≠§Á∂≤ÂùÄÂÆåÂÖ®‰∏ÄËá¥</p>
            </div>
        </section>
    </main>

    <div id="toast-notif" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-5 rounded-2xl shadow-2xl text-sm font-bold transform translate-y-40 opacity-0 transition-all duration-500 z-50 flex items-center gap-4 border border-white/10">
        <i data-lucide="check-circle" class="w-6 h-6 text-emerald-400"></i>
        <span id="toast-text"></span>
    </div>

    <script>
        lucide.createIcons();

        const jsonInput = document.getElementById('json-input');
        const renderMount = document.getElementById('flex-render-mount');
        const liffIdInput = document.getElementById('liff-id-input');
        const statusIndicator = document.getElementById('liff-status-indicator');
        const userStatusText = document.getElementById('user-status-text');
        const debugUrl = document.getElementById('debug-url');
        const altTextInput = document.getElementById('alt-text-input');
        const urlLenBadge = document.getElementById('url-len-badge');

        let liffReady = false;

        const welcomeMessage = {
            "type": "bubble",
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    { "type": "text", "text": "Flex Sender v2.0", "weight": "bold", "size": "xl", "color": "#111111" },
                    { "type": "text", "text": "Ê≠£ÂºèÁâàÈÉ®ÁΩ≤ÊàêÂäüÔºÅÁèæÂú®ÊÇ®ÂèØ‰ª•Á∑®ËºØÂ∑¶ÂÅ¥ JSONÔºåÁ≥ªÁµ±Â∞áËá™ÂãïÂ•óÁî® LZ Â£ìÁ∏ÆÊäÄË°ìË£Ω‰ΩúË∂ÖÁü≠ÂàÜ‰∫´ÈÄ£Áµê„ÄÇ", "size": "sm", "color": "#666666", "margin": "md", "wrap": true }
                ]
            }
        };

        window.onload = () => {
            const currentBaseUrl = window.location.href.split('?')[0];
            debugUrl.innerText = currentBaseUrl;

            const urlParams = new URLSearchParams(window.location.search);
            const compressedJson = urlParams.get('msg');
            const liffIdParam = urlParams.get('liffId');
            
            if (compressedJson) {
                try {
                    const decompressed = LZString.decompressFromEncodedURIComponent(compressedJson);
                    if (decompressed) {
                        jsonInput.value = JSON.stringify(JSON.parse(decompressed), null, 4);
                    } else {
                        const decoded = decodeURIComponent(escape(atob(compressedJson)));
                        jsonInput.value = JSON.stringify(JSON.parse(decoded), null, 4);
                    }
                } catch (e) {
                    jsonInput.value = JSON.stringify(welcomeMessage, null, 4);
                }
            } else {
                jsonInput.value = JSON.stringify(welcomeMessage, null, 4);
            }

            if (liffIdParam) {
                liffIdInput.value = liffIdParam;
                initLIFF(liffIdParam);
            } else {
                const savedId = localStorage.getItem('liff_id_v2.0');
                if (savedId) {
                    liffIdInput.value = savedId;
                    initLIFF(savedId);
                }
            }
            updateLivePreview();
        };

        async function initLIFF(id) {
            try {
                await liff.init({ liffId: id });
                liffReady = true;
                syncAuthStatus();
                showToast("LIFF ÈÄ£Á∑öÂ∑≤ÊàêÂäüÂ∞çÊé•");
            } catch (err) {
                liffReady = false;
                showToast("ÈÄ£Á∑öÂ§±ÊïóÔºöË´ãÊ™¢Êü• ID ËàáÁ∂≤ÂùÄ");
            }
        }

        function syncAuthStatus() {
            if (liff.isLoggedIn()) {
                statusIndicator.className = "status-dot status-online";
                liff.getProfile().then(p => {
                    userStatusText.innerText = `Online: ${p.displayName}`;
                });
                document.getElementById('btn-login-trigger').classList.add('hidden');
            } else {
                statusIndicator.className = "status-dot status-offline";
                userStatusText.innerText = "System Standby";
                document.getElementById('btn-login-trigger').classList.remove('hidden');
            }
        }

        liffIdInput.addEventListener('blur', () => {
            const id = liffIdInput.value.trim();
            if (id) {
                localStorage.setItem('liff_id_v2.0', id);
                initLIFF(id);
            }
        });

        function generateShareUrl() {
            const jsonStr = jsonInput.value.trim();
            const liffId = liffIdInput.value.trim();
            try {
                const obj = JSON.parse(jsonStr);
                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(obj));
                const currentBaseUrl = window.location.href.split('?')[0];
                let shareUrl = `${currentBaseUrl}?msg=${compressed}`;
                if (liffId) shareUrl += `&liffId=${liffId}`;
                
                const el = document.createElement('textarea');
                el.style.position = 'fixed'; el.style.opacity = 0;
                el.value = shareUrl;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showToast(`Ê•µÁü≠ÈÄ£ÁµêÂ∑≤ÊàêÂäüË£Ω‰Ωú‰∏¶Ë§áË£ΩÔºÅ`);
            } catch (e) {
                showToast("JSON Ë™ûÊ≥ïÈåØË™§");
            }
        }

        function updateLivePreview() {
            try {
                let data = JSON.parse(jsonInput.value.trim());
                if (data.contents) data = data.contents;
                renderMount.innerHTML = "";
                if (data.type === "carousel") {
                    const scrollBox = document.createElement('div');
                    scrollBox.style.display = "flex";
                    scrollBox.style.gap = "15px";
                    scrollBox.style.overflowX = "auto";
                    scrollBox.style.paddingBottom = "15px";
                    data.contents.forEach(b => scrollBox.appendChild(createFlexBubble(b)));
                    renderMount.appendChild(scrollBox);
                } else {
                    renderMount.appendChild(createFlexBubble(data));
                }
            } catch (e) {}
        }

        function createFlexBubble(json) {
            const bubble = document.createElement('div');
            bubble.className = "flex-bubble-card";
            bubble.style.width = json.size === "micro" ? "180px" : (json.size === "nano" ? "140px" : "320px");
            bubble.style.flexShrink = "0";
            if (json.hero) bubble.appendChild(renderFlexComp(json.hero));
            if (json.body) bubble.appendChild(renderFlexComp(json.body));
            if (json.footer) bubble.appendChild(renderFlexComp(json.footer));
            return bubble;
        }

        function renderFlexComp(comp) {
            if (!comp) return document.createElement('div');
            let el;
            switch(comp.type) {
                case 'box':
                    el = document.createElement('div');
                    el.style.display = "flex";
                    el.style.flexDirection = comp.layout === 'horizontal' ? 'row' : 'column';
                    if (comp.paddingAll) el.style.padding = "16px";
                    if (comp.backgroundColor) el.style.backgroundColor = comp.backgroundColor;
                    if (comp.spacing) el.style.gap = "10px";
                    comp.contents?.forEach(c => el.appendChild(renderFlexComp(c)));
                    break;
                case 'text':
                    el = document.createElement('div');
                    el.innerText = comp.text;
                    el.style.fontSize = comp.size === 'xl' ? '24px' : (comp.size === 'xs' ? '12px' : '15px');
                    el.style.fontWeight = comp.weight === 'bold' ? '900' : '400';
                    el.style.color = comp.color || '#333';
                    if (comp.align === 'center') el.style.textAlign = 'center';
                    if (comp.margin) el.style.marginTop = "8px";
                    if (comp.wrap) el.style.wordBreak = "break-all";
                    break;
                case 'image':
                    el = document.createElement('img');
                    el.src = comp.url;
                    el.style.width = "100%";
                    el.style.display = "block";
                    el.style.objectFit = comp.aspectMode || "cover";
                    if (comp.aspectRatio) el.style.aspectRatio = comp.aspectRatio.replace(':', '/');
                    break;
                case 'button':
                    el = document.createElement('div');
                    el.innerText = comp.action?.label || 'ÊåâÈàï';
                    el.style.textAlign = "center";
                    el.style.padding = "12px";
                    el.style.margin = "5px";
                    el.style.borderRadius = "12px";
                    el.style.fontSize = "14px";
                    el.style.fontWeight = "900";
                    if (comp.style === 'primary') {
                        el.style.background = comp.color || "#06C755";
                        el.style.color = "white";
                    } else {
                        el.style.border = "1px solid #e5e7eb";
                        el.style.color = "#4b5563";
                    }
                    break;
                default:
                    el = document.createElement('div');
            }
            return el;
        }

        async function sendFlexMessage() {
            if (!liffReady) return showToast("Ë´ãÁ¢∫Ë™ç LIFF ÂàùÂßãÂåñÊàêÂäü");
            if (!liff.isLoggedIn()) return liff.login();
            try {
                let flex = JSON.parse(jsonInput.value.trim());
                if (flex.contents) flex = flex.contents;
                if (Array.isArray(flex)) flex = { "type": "carousel", "contents": flex };
                const res = await liff.shareTargetPicker([
                    { "type": "flex", "altText": altTextInput.value, "contents": flex }
                ]);
                if (res) showToast("üéâ Ë®äÊÅØÂ∑≤ÊàêÂäüÁôºÈÄÅÔºÅ");
            } catch (err) {
                showToast("ÁôºÈÄÅÂÖßÂÆπ‰∏çÁ¨¶Ë¶èÁØÑ");
            }
        }

        function formatCode() {
            try {
                const obj = JSON.parse(jsonInput.value);
                jsonInput.value = JSON.stringify(obj, null, 4);
                updateLivePreview();
            } catch (e) { showToast("Ë™ûÊ≥ïÈåØË™§"); }
        }

        function clearAll() {
            jsonInput.value = "";
            renderMount.innerHTML = '<div class="text-center text-slate-400 text-sm mt-20 italic">Á≠âÂæÖËº∏ÂÖ• JSON...</div>';
            showToast("Á∑®ËºØÂô®Â∑≤Ê∏ÖÁ©∫");
        }

        function showToast(msg) {
            const t = document.getElementById('toast-notif');
            document.getElementById('toast-text').innerText = msg;
            t.classList.remove('translate-y-40', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-40', 'opacity-0'), 3000);
        }

        jsonInput.addEventListener('input', () => {
            updateLivePreview();
            const len = jsonInput.value.length;
            urlLenBadge.innerText = `${len} chars`;
            urlLenBadge.className = `text-[9px] px-2 py-0.5 rounded font-bold ${len > 3000 ? 'bg-red-100 text-red-500' : 'bg-slate-100 text-slate-500'}`;
        });
    </script>
</body>
</html>
