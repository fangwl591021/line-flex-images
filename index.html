// --- 在 updateLivePreview 函數中修正 ---
function updateLivePreview() {
    try {
        // 處理空值情況
        const inputText = jsonInput.value.trim();
        if (!inputText) {
            renderMount.innerHTML = '<div class="text-center text-gray-400 p-8">請輸入有效的JSON格式</div>';
            return;
        }
        
        let data = JSON.parse(inputText);
        
        // 處理不同的JSON結構
        if (data.contents) {
            data = data.contents;
        } else if (data.type === "carousel" && Array.isArray(data.contents)) {
            // 已經是輪播格式，保持不變
        } else if (data.type === "bubble") {
            // 單一氣泡，直接使用
        } else {
            throw new Error("不支援的JSON格式");
        }
        
        renderMount.innerHTML = "";
        
        if (Array.isArray(data)) {
            // 如果是陣列，建立輪播
            const scrollBox = document.createElement('div');
            scrollBox.style.display = "flex";
            scrollBox.style.gap = "12px";
            scrollBox.style.overflowX = "auto";
            scrollBox.style.paddingBottom = "12px";
            scrollBox.style.width = "100%";
            
            data.forEach(bubbleData => {
                const bubble = createFlexBubble(bubbleData);
                if (bubble) scrollBox.appendChild(bubble);
            });
            
            renderMount.appendChild(scrollBox);
        } else if (data.type === "carousel") {
            // 處理標準carousel格式
            const scrollBox = document.createElement('div');
            scrollBox.style.display = "flex";
            scrollBox.style.gap = "12px";
            scrollBox.style.overflowX = "auto";
            scrollBox.style.paddingBottom = "12px";
            scrollBox.style.width = "100%";
            
            data.contents.forEach(bubbleData => {
                const bubble = createFlexBubble(bubbleData);
                if (bubble) scrollBox.appendChild(bubble);
            });
            
            renderMount.appendChild(scrollBox);
        } else {
            // 單一氣泡
            const bubble = createFlexBubble(data);
            if (bubble) renderMount.appendChild(bubble);
        }
    } catch (e) {
        renderMount.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i>
                    <p class="text-sm font-bold text-red-600">JSON 解析錯誤</p>
                </div>
                <p class="text-xs text-red-500">${e.message}</p>
                <p class="text-xs text-gray-500 mt-2">請檢查JSON格式是否正確</p>
            </div>
        `;
        lucide.createIcons(); // 重新載入圖標
    }
}

// --- 修正 createFlexBubble 函數 ---
function createFlexBubble(json) {
    if (!json || typeof json !== 'object') {
        console.error('無效的氣泡數據');
        return null;
    }
    
    const bubble = document.createElement('div');
    bubble.className = "flex-bubble-card";
    
    // 設定氣泡大小
    if (json.size === "micro") {
        bubble.style.width = "180px";
    } else if (json.size === "nano") {
        bubble.style.width = "140px";
    } else {
        bubble.style.width = "280px";
    }
    
    bubble.style.flexShrink = "0";
    bubble.style.margin = "0 auto"; // 置中顯示
    
    // 依序渲染各部分
    if (json.hero) {
        const heroElement = renderFlexComp(json.hero);
        if (heroElement) bubble.appendChild(heroElement);
    }
    
    if (json.body) {
        const bodyElement = renderFlexComp(json.body);
        if (bodyElement) bubble.appendChild(bodyElement);
    }
    
    if (json.footer) {
        const footerElement = renderFlexComp(json.footer);
        if (footerElement) bubble.appendChild(footerElement);
    }
    
    return bubble;
}

// --- 增強 renderFlexComp 函數 ---
function renderFlexComp(comp) {
    if (!comp || !comp.type) {
        console.warn('無效的組件數據');
        return document.createElement('div');
    }
    
    let el;
    
    try {
        switch(comp.type) {
            case 'box':
                el = document.createElement('div');
                el.style.display = "flex";
                el.style.flexDirection = comp.layout === 'horizontal' ? 'row' : 'column';
                el.style.alignItems = comp.position === 'relative' ? 'stretch' : 'flex-start';
                
                // 處理內距
                if (comp.paddingAll) {
                    el.style.padding = comp.paddingAll + 'px';
                } else if (comp.paddingTop || comp.paddingBottom || comp.paddingLeft || comp.paddingRight) {
                    const padding = [
                        comp.paddingTop || 0,
                        comp.paddingRight || 0,
                        comp.paddingBottom || 0,
                        comp.paddingLeft || 0
                    ].join('px ') + 'px';
                    el.style.padding = padding;
                }
                
                // 背景顏色
                if (comp.backgroundColor) {
                    el.style.backgroundColor = comp.backgroundColor;
                }
                
                // 間距
                if (comp.spacing) {
                    el.style.gap = comp.spacing + 'px';
                }
                
                // 圓角
                if (comp.cornerRadius) {
                    el.style.borderRadius = comp.cornerRadius + 'px';
                }
                
                // 遞迴渲染子組件
                if (Array.isArray(comp.contents)) {
                    comp.contents.forEach(child => {
                        const childEl = renderFlexComp(child);
                        if (childEl) el.appendChild(childEl);
                    });
                }
                break;
                
            case 'text':
                el = document.createElement('div');
                el.innerText = comp.text || '';
                
                // 文字大小映射
                const sizeMap = {
                    'xxs': '10px',
                    'xs': '12px',
                    'sm': '14px',
                    'md': '16px',
                    'lg': '18px',
                    'xl': '20px',
                    'xxl': '24px',
                    '3xl': '28px',
                    '4xl': '32px',
                    '5xl': '36px'
                };
                
                el.style.fontSize = sizeMap[comp.size] || '14px';
                el.style.fontWeight = comp.weight === 'bold' ? '700' : (comp.weight === 'regular' ? '400' : 'normal');
                el.style.color = comp.color || '#333333';
                
                if (comp.align === 'center') {
                    el.style.textAlign = 'center';
                } else if (comp.align === 'end') {
                    el.style.textAlign = 'right';
                }
                
                if (comp.margin === 'md') {
                    el.style.margin = '8px 0';
                } else if (comp.margin === 'lg') {
                    el.style.margin = '16px 0';
                }
                
                if (comp.wrap) {
                    el.style.wordBreak = "break-word";
                    el.style.whiteSpace = "normal";
                }
                break;
                
            case 'image':
                el = document.createElement('img');
                el.src = comp.url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDIwMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSIxMDAiIHk9IjYwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5Y2EwYjEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBQbGFjZWhvbGRlcjwvdGV4dD48L3N2Zz4=';
                el.style.width = "100%";
                el.style.display = "block";
                el.style.maxWidth = "100%";
                
                if (comp.aspectMode === 'fit') {
                    el.style.objectFit = "contain";
                    el.style.height = "auto";
                } else {
                    el.style.objectFit = "cover";
                }
                
                if (comp.aspectRatio) {
                    el.style.aspectRatio = comp.aspectRatio.replace(':', '/');
                }
                break;
                
            case 'button':
                el = document.createElement('button');
                el.type = "button";
                el.innerText = comp.action?.label || comp.text || '按鈕';
                el.style.textAlign = "center";
                el.style.padding = "10px 16px";
                el.style.margin = "4px";
                el.style.borderRadius = "8px";
                el.style.fontSize = "14px";
                el.style.fontWeight = "bold";
                el.style.cursor = "pointer";
                el.style.border = "none";
                el.style.width = "calc(100% - 8px)";
                el.style.display = "block";
                
                if (comp.style === 'primary') {
                    el.style.background = comp.color || "#06C755";
                    el.style.color = "white";
                } else if (comp.style === 'secondary') {
                    el.style.background = "#f3f4f6";
                    el.style.color = "#374151";
                    el.style.border = "1px solid #d1d5db";
                } else if (comp.style === 'link') {
                    el.style.background = "transparent";
                    el.style.color = "#3b82f6";
                    el.style.textDecoration = "underline";
                } else {
                    el.style.background = "#f9fafb";
                    el.style.color = "#4b5563";
                    el.style.border = "1px solid #e5e7eb";
                }
                
                // 模擬按鈕點擊效果
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    showToast(`按鈕點擊: ${el.innerText}`);
                });
                break;
                
            default:
                el = document.createElement('div');
                el.innerText = `未支援的組件類型: ${comp.type}`;
                el.style.color = "#9ca3af";
                el.style.fontSize = "12px";
                el.style.padding = "8px";
                el.style.textAlign = "center";
        }
    } catch (error) {
        console.error('渲染組件時出錯:', error);
        el = document.createElement('div');
        el.innerText = `渲染錯誤: ${comp.type}`;
        el.style.color = "#ef4444";
        el.style.fontSize = "12px";
        el.style.padding = "8px";
        el.style.background = "#fee2e2";
    }
    
    return el;
}

// --- 新增：自動格式化功能 ---
jsonInput.addEventListener('blur', () => {
    if (jsonInput.value.trim()) {
        try {
            const formatted = JSON.stringify(JSON.parse(jsonInput.value), null, 2);
            jsonInput.value = formatted;
        } catch (e) {
            // 保持原樣，不格式化
        }
    }
});

// --- 新增：快捷鍵支援 ---
jsonInput.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + S 快速預覽
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        updateLivePreview();
        showToast('預覽已更新');
    }
    
    // Ctrl/Cmd + Enter 發送
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        sendFlexMessage();
    }
});

// --- 修正：初始化時載入預設範例 ---
window.onload = () => {
    debugUrl.innerText = window.location.href.split('?')[0];
    const savedId = localStorage.getItem('liff_id_v1.3');
    if (savedId) {
        liffIdInput.value = savedId;
        initLIFF(savedId);
    }
    
    // 使用更完整的範例
    const exampleJSON = {
        "type": "bubble",
        "size": "kilo",
        "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
                {
                    "type": "text",
                    "text": "Flex Sender Pro v1.3",
                    "weight": "bold",
                    "size": "xl",
                    "color": "#111827",
                    "align": "center"
                },
                {
                    "type": "text",
                    "text": "請在左側貼上您的Flex Message JSON代碼，即時預覽將會顯示在這裡。",
                    "size": "sm",
                    "color": "#6b7280",
                    "margin": "md",
                    "wrap": true
                }
            ],
            "paddingAll": "20px"
        }
    };
    
    jsonInput.value = JSON.stringify(exampleJSON, null, 4);
    updateLivePreview();
};
