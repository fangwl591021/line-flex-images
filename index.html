<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex Sender Ultra v1.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Fira+Code:wght@400;500&display=swap');
        
        :root {
            --line-green: #06C755;
            --line-blue: #748da6;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9; 
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        /* 頂部導航欄優化 */
        header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 2rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            z-index: 50;
        }

        .liff-id-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            width: 500px;
        }

        .liff-id-box:focus-within {
            border-color: var(--line-green);
            background: white;
            box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1);
        }

        /* 主區域佈局 */
        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* 左側編輯器 */
        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        #json-input {
            flex: 1;
            padding: 2rem;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            border: none;
            outline: none;
            resize: none;
            background: #fafafa;
            color: #1e293b;
        }

        /* 右側預覽區 */
        .preview-section {
            width: 500px;
            background: #f1f5f9;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
        }

        /* 手機框架 */
        .phone-mockup {
            width: 320px;
            height: 580px;
            background: var(--line-blue);
            border-radius: 40px;
            border: 10px solid #1e293b;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .phone-speaker {
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.05);
        }

        .phone-speaker::after {
            content: '';
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .phone-screen {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
        }

        .phone-screen::-webkit-scrollbar { display: none; }

        /* Flex 渲染件 */
        .flex-bubble-render {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-online { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-offline { background: #ef4444; }

        /* 按鈕樣式 */
        .btn-primary {
            background: var(--line-green);
            color: white;
            padding: 10px 24px;
            border-radius: 12px;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-4">
            <div class="bg-[#06C755] p-2 rounded-xl text-white">
                <i data-lucide="send"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-800 m-0 leading-tight flex items-center gap-2">
                    Flex Sender Ultra <span class="text-[10px] text-slate-400">v1.2</span>
                    <span id="liff-status-dot" class="status-dot status-offline"></span>
                </h1>
                <p id="user-display" class="text-[10px] text-slate-400 font-bold uppercase m-0">Offline Mode</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="liff-id-box">
                <i data-lucide="key" class="w-4 h-4 text-slate-400"></i>
                <input type="text" id="liff-id-input" placeholder="貼入 LIFF ID (例如 200xxxxxxx-xxxxxxxx)" 
                       class="bg-transparent text-sm w-full outline-none font-mono">
            </div>
            <button id="btn-login" onclick="liff.login()" class="hidden text-sm font-bold text-slate-600 hover:text-slate-900">登入</button>
            <button onclick="shareTargetPicker()" class="btn-primary shadow-lg shadow-emerald-100">
                <i data-lucide="share-2" class="w-4 h-4"></i> 發送
            </button>
        </div>
    </header>

    <main>
        <section class="editor-section">
            <div class="px-6 py-3 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-4">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">JSON Editor</span>
                    <input type="text" id="alt-text-input" value="您收到了一則新訊息" 
                           class="text-xs bg-slate-100 border border-slate-200 rounded px-3 py-1 w-64 outline-none font-medium text-slate-600 focus:border-emerald-500">
                </div>
                <button onclick="formatJSON()" class="text-xs font-bold text-emerald-600 flex items-center gap-1 hover:underline">
                    <i data-lucide="wand-2" class="w-3 h-3"></i> 格式化 JSON
                </button>
            </div>
            <textarea id="json-input" spellcheck="false" placeholder="在此處貼上 LINE Flex Message JSON..."></textarea>
        </section>

        <section class="preview-section">
            <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-6">Live Preview</span>
            <div class="phone-mockup">
                <div class="phone-speaker"></div>
                <div class="phone-screen" id="preview-screen">
                    <!-- 渲染結果會在這裡 -->
                    <div id="flex-render-root"></div>
                </div>
            </div>
            <p class="mt-6 text-[10px] text-slate-400 text-center">
                Endpoint: <span id="current-url-display" class="font-mono">Detecting...</span><br>
                ※ 預覽僅供參考，實際效果以手機端為準
            </p>
        </section>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-3 rounded-2xl shadow-2xl text-sm font-bold transform translate-y-32 opacity-0 transition-all duration-500 z-50"></div>

    <script>
        lucide.createIcons();

        const jsonInput = document.getElementById('json-input');
        const renderRoot = document.getElementById('flex-render-root');
        const liffIdInput = document.getElementById('liff-id-input');
        const statusDot = document.getElementById('liff-status-dot');
        const userDisplay = document.getElementById('user-display');
        const currentUrlDisplay = document.getElementById('current-url-display');
        const altTextInput = document.getElementById('alt-text-input');

        let isInitialized = false;

        // 預設簡單範本
        const defaultJSON = {
            "type": "bubble",
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    { "type": "text", "text": "Flex Sender Ready", "weight": "bold", "size": "xl" },
                    { "type": "text", "text": "請在左側貼上 JSON 代碼開始預覽", "color": "#666666", "margin": "md" }
                ]
            }
        };

        window.onload = () => {
            currentUrlDisplay.innerText = window.location.href.split('?')[0];
            const savedId = localStorage.getItem('liff_id_v1.2');
            if (savedId) {
                liffIdInput.value = savedId;
                initLIFF(savedId);
            }
            jsonInput.value = JSON.stringify(defaultJSON, null, 2);
            updatePreview();
        };

        async function initLIFF(id) {
            try {
                await liff.init({ liffId: id });
                isInitialized = true;
                updateUI();
                showToast("LIFF 初始化成功");
            } catch (err) {
                showToast("初始化失敗：請檢查 ID 設定");
            }
        }

        function updateUI() {
            if (liff.isLoggedIn()) {
                statusDot.className = "status-dot status-online";
                liff.getProfile().then(p => {
                    userDisplay.innerText = `Online: ${p.displayName}`;
                });
                document.getElementById('btn-login').classList.add('hidden');
            } else {
                statusDot.className = "status-dot status-offline";
                userDisplay.innerText = "Offline Mode";
                document.getElementById('btn-login').classList.remove('hidden');
            }
        }

        liffIdInput.addEventListener('blur', () => {
            const id = liffIdInput.value.trim();
            if (id) {
                localStorage.setItem('liff_id_v1.2', id);
                initLIFF(id);
            }
        });

        // --- 預覽渲染引擎 ---
        function updatePreview() {
            try {
                let data = JSON.parse(jsonInput.value.trim());
                if (data.contents) data = data.contents;
                
                renderRoot.innerHTML = "";
                
                if (data.type === "carousel") {
                    const scroll = document.createElement('div');
                    scroll.style.display = "flex";
                    scroll.style.gap = "10px";
                    scroll.style.overflowX = "auto";
                    scroll.style.paddingBottom = "10px";
                    data.contents.forEach(b => scroll.appendChild(createBubble(b)));
                    renderRoot.appendChild(scroll);
                } else {
                    renderRoot.appendChild(createBubble(data));
                }
            } catch (e) {}
        }

        function createBubble(json) {
            const bubble = document.createElement('div');
            bubble.className = "flex-bubble-render";
            bubble.style.width = json.size === "micro" ? "160px" : "240px";
            bubble.style.flexShrink = "0";

            if (json.hero) bubble.appendChild(renderElement(json.hero));
            if (json.body) bubble.appendChild(renderElement(json.body));
            if (json.footer) bubble.appendChild(renderElement(json.footer));
            return bubble;
        }

        function renderElement(el) {
            if (!el) return document.createElement('div');
            let div;
            switch(el.type) {
                case 'box':
                    div = document.createElement('div');
                    div.style.display = "flex";
                    div.style.flexDirection = el.layout === 'horizontal' ? 'row' : 'column';
                    if (el.paddingAll) div.style.padding = "12px";
                    if (el.backgroundColor) div.style.backgroundColor = el.backgroundColor;
                    el.contents?.forEach(c => div.appendChild(renderElement(c)));
                    break;
                case 'text':
                    div = document.createElement('div');
                    div.innerText = el.text;
                    div.style.fontSize = el.size === 'xl' ? '18px' : '13px';
                    div.style.fontWeight = el.weight === 'bold' ? '700' : '400';
                    div.style.color = el.color || '#333';
                    if (el.margin) div.style.marginTop = "8px";
                    if (el.wrap) div.style.wordBreak = "break-all";
                    break;
                case 'image':
                    div = document.createElement('img');
                    div.src = el.url;
                    div.style.width = "100%";
                    div.style.display = "block";
                    div.style.objectFit = "cover";
                    break;
                case 'button':
                    div = document.createElement('div');
                    div.innerText = el.action?.label || 'Button';
                    div.style.textAlign = "center";
                    div.style.padding = "8px";
                    div.style.margin = "4px";
                    div.style.borderRadius = "8px";
                    div.style.fontSize = "12px";
                    div.style.fontWeight = "bold";
                    if (el.style === 'primary') {
                        // 修復：將 var(--line-green) 改為字串格式
                        div.style.background = el.color || "#06C755";
                        div.style.color = "white";
                    } else {
                        div.style.border = "1px solid #ddd";
                    }
                    break;
                default:
                    div = document.createElement('div');
            }
            return div;
        }

        async function shareTargetPicker() {
            if (!isInitialized) return showToast("請確認 LIFF 初始化成功");
            if (!liff.isLoggedIn()) return liff.login();

            try {
                let flex = JSON.parse(jsonInput.value.trim());
                if (flex.contents) flex = flex.contents;
                if (Array.isArray(flex)) flex = { "type": "carousel", "contents": flex };

                const res = await liff.shareTargetPicker([
                    { "type": "flex", "altText": altTextInput.value, "contents": flex }
                ]);
                if (res) showToast("訊息已傳送");
            } catch (err) {
                showToast("語法錯誤，發送失敗");
            }
        }

        function formatJSON() {
            try {
                const obj = JSON.parse(jsonInput.value);
                jsonInput.value = JSON.stringify(obj, null, 2);
                updatePreview();
            } catch (e) { showToast("代碼有誤"); }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 2500);
        }

        jsonInput.addEventListener('input', updatePreview);
    </script>
</body>
</html>
