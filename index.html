<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Flex Message Sender Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Fira+Code:wght@400;500&display=swap');
        
        :root {
            --line-green: #06C755;
            --line-chat-bg: #748da6;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc; 
            height: 100vh;
            overflow: hidden;
        }

        .json-editor { 
            font-family: 'Fira Code', monospace; 
            line-height: 1.5;
            tab-size: 2;
        }

        /* 手機模擬器樣式優化 */
        .phone-frame {
            width: 340px;
            height: 600px;
            background-color: var(--line-chat-bg);
            border-radius: 32px;
            border: 10px solid #1e293b;
            position: relative;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .phone-top {
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phone-screen {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            scrollbar-width: none;
        }
        .phone-screen::-webkit-scrollbar { display: none; }

        /* Flex Bubble 基礎渲染 */
        .flex-bubble {
            background-color: #ffffff;
            border-radius: 14px;
            overflow: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .flex-box-vertical { display: flex; flex-direction: column; }
        .flex-box-horizontal { display: flex; flex-direction: row; }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; transition: all 0.3s; }
        .status-on { background-color: var(--line-green); box-shadow: 0 0 10px var(--line-green); }
        .status-off { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col">

    <!-- 頂部導航列 -->
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0 z-30">
        <div class="flex items-center gap-4">
            <div class="bg-[#06C755] p-2 rounded-xl text-white">
                <i data-lucide="send" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-800 tracking-tight flex items-center gap-2">
                    Flex Sender Pro
                    <span id="liff-status-dot" class="status-dot status-off"></span>
                </h1>
                <p id="liff-user-name" class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">OFFLINE</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- 加寬後的 ID 輸入框 -->
            <div class="flex items-center gap-3 bg-slate-50 px-4 py-2 rounded-xl border border-slate-200 transition-all focus-within:ring-2 focus-within:ring-emerald-500 focus-within:bg-white">
                <i data-lucide="key" class="w-4 h-4 text-slate-400"></i>
                <input type="text" id="liff-id-input" placeholder="貼入 LIFF ID (例如 200xxxxxxx-xxxxxxxx)" 
                       class="bg-transparent text-sm w-[400px] outline-none border-none font-mono text-slate-700 placeholder-slate-300">
            </div>

            <button id="btn-login" onclick="handleLogin()" class="hidden bg-slate-800 hover:bg-slate-700 text-white px-6 py-2 rounded-xl text-sm font-bold transition shadow-md">
                登入
            </button>
            <button id="btn-share" onclick="shareTargetPicker()" class="bg-[#06C755] hover:bg-[#05b14c] text-white px-8 py-2 rounded-xl text-sm font-black transition-all transform active:scale-95 shadow-lg flex items-center gap-2">
                <i data-lucide="share-2" class="w-4 h-4"></i> 發送訊息
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <!-- 左側：編輯器 -->
        <section class="flex-1 flex flex-col bg-white">
            <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <div class="flex items-center gap-6">
                    <span class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="code" class="w-4 h-4"></i> JSON Editor
                    </span>
                    <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg px-3 py-1.5">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">預覽文字</span>
                        <input type="text" id="alt-text-input" value="您收到了一則新訊息" class="text-xs outline-none border-none w-48 font-bold">
                    </div>
                </div>
                <button onclick="formatJSON()" class="px-4 py-1.5 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 transition flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> 格式化
                </button>
            </div>
            <textarea id="json-input" class="flex-1 p-6 text-sm json-editor outline-none resize-none custom-scrollbar bg-white" placeholder='請在此貼上 JSON 代碼...' spellcheck="false"></textarea>
        </section>

        <!-- 右側：手機預覽 -->
        <section class="w-[450px] bg-slate-50 flex flex-col items-center justify-center p-6 border-l border-slate-200">
            <div class="mb-6 flex flex-col items-center">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">Device Preview</span>
                <div class="phone-frame">
                    <div class="phone-top">
                        <div class="w-10 h-1 bg-white/10 rounded-full"></div>
                    </div>
                    <div class="phone-screen custom-scrollbar" id="phone-content">
                        <!-- 渲染內容 -->
                        <div id="flex-render-target" class="flex flex-col gap-4"></div>
                    </div>
                </div>
            </div>
            
            <div class="text-[10px] text-slate-400 flex flex-col items-center gap-1 font-medium">
                <p>Endpoint: <span id="current-url" class="font-mono text-slate-300">Detecting...</span></p>
                <p>※ 請確保圖片網址皆為 HTTPS 且公開可存取</p>
            </div>
        </section>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-3 rounded-2xl shadow-2xl text-sm font-bold transform translate-y-32 opacity-0 transition-all duration-500 z-50"></div>

    <script>
        lucide.createIcons();

        const jsonInput = document.getElementById('json-input');
        const flexRenderTarget = document.getElementById('flex-render-target');
        const liffIdInput = document.getElementById('liff-id-input');
        const statusDot = document.getElementById('liff-status-dot');
        const userInfoText = document.getElementById('liff-user-name');
        const btnLogin = document.getElementById('btn-login');
        const currentUrlText = document.getElementById('current-url');
        const altTextInput = document.getElementById('alt-text-input');

        let isLiffReady = false;

        // 初始化範例 (清空大部分測試訊息，只留一個基本骨架)
        const baseTemplate = {
            "type": "bubble",
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    { "type": "text", "text": "Flex Message 編輯器", "weight": "bold", "size": "xl" },
                    { "type": "text", "text": "在此貼上 JSON 即可預覽發送效果", "size": "sm", "color": "#888888", "margin": "md", "wrap": true }
                ]
            }
        };

        window.onload = () => {
            currentUrlText.innerText = window.location.href.split('?')[0];
            const savedId = localStorage.getItem('liff_id_pro_v1');
            if (savedId) {
                liffIdInput.value = savedId;
                initLIFF(savedId);
            }
            jsonInput.value = JSON.stringify(baseTemplate, null, 2);
            updatePreview();
        };

        async function initLIFF(id) {
            try {
                await liff.init({ liffId: id });
                isLiffReady = true;
                updateAuthUI();
                showToast("LIFF 連線已建立");
            } catch (err) {
                isLiffReady = false;
                showToast("初始化失敗：請檢查 ID 或 Endpoint 設定");
            }
        }

        function updateAuthUI() {
            if (liff.isLoggedIn()) {
                statusDot.className = "status-dot status-on";
                btnLogin.classList.add('hidden');
                liff.getProfile().then(p => {
                    userInfoText.innerText = `ONLINE: ${p.displayName}`;
                });
            } else {
                statusDot.className = "status-dot status-off";
                btnLogin.classList.remove('hidden');
                userInfoText.innerText = "OFFLINE";
            }
        }

        function handleLogin() {
            if (isLiffReady) liff.login();
        }

        liffIdInput.addEventListener('blur', () => {
            const id = liffIdInput.value.trim();
            if (id) {
                localStorage.setItem('liff_id_pro_v1', id);
                initLIFF(id);
            }
        });

        // --- 優化後的渲染引擎 ---
        function updatePreview() {
            try {
                let json = JSON.parse(jsonInput.value.trim());
                if (json.contents) json = json.contents;
                
                flexRenderTarget.innerHTML = "";
                
                if (json.type === "carousel") {
                    const scroll = document.createElement('div');
                    scroll.className = "flex overflow-x-auto gap-3 pb-2";
                    json.contents.forEach(b => scroll.appendChild(createBubble(b)));
                    flexRenderTarget.appendChild(scroll);
                } else if (json.type === "bubble") {
                    flexRenderTarget.appendChild(createBubble(json));
                } else if (Array.isArray(json)) {
                    const scroll = document.createElement('div');
                    scroll.className = "flex overflow-x-auto gap-3 pb-2";
                    json.forEach(b => scroll.appendChild(createBubble(b)));
                    flexRenderTarget.appendChild(scroll);
                }
            } catch (e) {
                // 語法錯誤時不更新預覽
            }
        }

        function createBubble(data) {
            const el = document.createElement('div');
            el.className = "flex-bubble shrink-0";
            el.style.width = data.size === "micro" ? "160px" : "260px";
            
            if (data.hero) el.appendChild(renderComp(data.hero));
            if (data.body) el.appendChild(renderComp(data.body));
            if (data.footer) el.appendChild(renderComp(data.footer));
            
            return el;
        }

        function renderComp(c) {
            if (!c) return document.createElement('div');
            let div;
            switch(c.type) {
                case 'box':
                    div = document.createElement('div');
                    div.className = `flex-${c.layout === 'horizontal' ? 'box-horizontal' : 'box-vertical'}`;
                    if (c.backgroundColor) div.style.backgroundColor = c.backgroundColor;
                    if (c.paddingAll) div.style.padding = '12px';
                    if (c.contents) c.contents.forEach(child => div.appendChild(renderComp(child)));
                    break;
                case 'text':
                    div = document.createElement('div');
                    div.innerText = c.text;
                    div.style.color = c.color || '#333';
                    div.style.fontSize = c.size === 'xl' ? '18px' : '13px';
                    div.style.fontWeight = c.weight === 'bold' ? '700' : '400';
                    if (c.wrap) div.style.wordBreak = 'break-all';
                    if (c.margin) div.style.marginTop = '8px';
                    break;
                case 'image':
                    div = document.createElement('img');
                    div.src = c.url;
                    div.style.width = '100%';
                    div.style.display = 'block';
                    div.style.objectFit = 'cover';
                    break;
                case 'button':
                    div = document.createElement('div');
                    div.innerText = c.action?.label || 'Button';
                    div.className = "text-center py-2 m-1 rounded-lg text-xs font-bold";
                    if (c.style === 'primary') {
                        div.style.backgroundColor = c.color || '#06C755';
                        div.style.color = 'white';
                    } else {
                        div.style.border = `1px solid ${c.color || '#ddd'}`;
                        div.style.color = c.color || '#666';
                    }
                    break;
                default:
                    div = document.createElement('div');
            }
            return div;
        }

        async function shareTargetPicker() {
            if (!isLiffReady) return showToast("請確認 LIFF 已初始化");
            if (!liff.isLoggedIn()) return liff.login();

            try {
                let flex = JSON.parse(jsonInput.value.trim());
                if (flex.contents) flex = flex.contents;
                if (Array.isArray(flex)) flex = { "type": "carousel", "contents": flex };

                const res = await liff.shareTargetPicker([
                    { "type": "flex", "altText": altTextInput.value, "contents": flex }
                ]);
                if (res) showToast("發送成功");
            } catch (err) {
                showToast("語法解析錯誤");
            }
        }

        function formatJSON() {
            try {
                const obj = JSON.parse(jsonInput.value);
                jsonInput.value = JSON.stringify(obj, null, 2);
                updatePreview();
            } catch (e) { showToast("語法有誤"); }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 2500);
        }

        jsonInput.addEventListener('input', updatePreview);
    </script>
</body>
</html>
